---
title: "Preliminary NPB Model for Birth Weight"
author: "Sheena Martenies"
date: "06/26/2020"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)

library(tidyverse)
library(lubridate)
library(haven)
library(readxl)

#' For ggplots
simple_theme <- theme(
  #aspect.ratio = 1,
  text  = element_text(family="Calibri",size = 12, color = 'black'),
  panel.spacing.y = unit(0,"cm"),
  panel.spacing.x = unit(0.25, "lines"),
  panel.grid.minor = element_line(color = "transparent"),
  panel.grid.major = element_line(color = "transparent"),
  panel.border=element_rect(fill = NA),
  panel.background=element_blank(),
  axis.ticks = element_line(colour = "black"),
  axis.text = element_text(color = "black", size=10),
  # legend.position = c(0.1,0.1),
  plot.margin=grid::unit(c(0,0,0,0), "mm"),
  legend.key = element_blank()
)
windowsFonts(Calibri=windowsFont("TT Calibri"))
options(scipen = 9999) #avoid scientific notation

#' -----------------------------------------------------------------------------
#' Install the new version of the package
#' -----------------------------------------------------------------------------

# library(devtools)
# install_github("lvhoskovec/mmpack", build_vignettes = TRUE, force = TRUE)

library(mmpack)
```

# Exploring the data set

The HS data set was previously used in the CEI paper (Martenies et al., 2019). In the original analysis, we used an exposure index based on the CalEnvironScreen tool. We observed lower birth weights and lower adiposity associated with higher index scores, driven largely by exposures to social indicators of health at the neighborhood level. Now, we are aiming to use methods for mixtures to try to identify which exposures are driving these association.

```{r, echo = T, include = F}

#' Read in the clean dataset
hs_data <- read_csv(here::here("Data", "HS_Clean_Data.csv"))
nrow(hs_data)

hs_data2 <- filter(hs_data, include == 1) %>% 
  select(
    #' Exposures
    mean_pm, mean_o3, pct_tree_cover, pct_impervious,
    mean_aadt_intensity, dist_m_tri:dist_m_mine_well, 
    cvd_rate_adj, res_rate_adj, violent_crime_rate, property_crime_rate,
    pct_less_hs, pct_unemp, pct_limited_eng, pct_hh_pov,
    
    #' Covariates     
    latina_re, black_re, other_re, 
    ed_no_hs, ed_hs, ed_aa, ed_4yr, 
    low_bmi, ovwt_bmi, obese_bmi,
    maternal_age, any_smoker, smokeSH, mean_cpss, mean_epsd,
    male, gest_age_w, 
    
    #' Outcomes 
    birth_weight) %>% 
  na.omit()
```

The complete data set for the birth weight outcome consists of n =  `r nrow(hs_data2)` participants. This represents `r paste0(round((nrow(hs_data2)/ nrow(hs_data)*100),2), "%")` of the original Healthy Start 1 cohort.

Of the `r nrow(hs_data2)` participants, `r round(sum(hs_data2$latina_re)/nrow(hs_data2),2)`% identify as Latina, `r round(sum(hs_data2$black_re)/nrow(hs_data2),2)`% identify as Black, and `r round(sum(hs_data2$latina_re)/nrow(hs_data2),2)`% identify as another non-NHW race or ethnicity. The median age of mothers in this dataset is `r round(median(hs_data2$maternal_age),2)` years.  `r round(sum(hs_data2$male)/nrow(hs_data2),2)`% of babies born were male.  

## Exposure data

We have included `r ncol(select(hs_data2, mean_pm:pct_hh_pov))` exposures in our analysis. 

These exposures are based on the census tract where each mother lived at the time of enrollment into Healthy Start. With the exception of air pollution (mean_pm and mean_o3), these are based on long-term averages at for each census tract. For mean_pm and mean_o3 are based on the average pollution levels across each pregnancy (est. conception date to delivery date) estimated using ordinary kriging and monitoring data.

```{r}
#' Exposure data
X <- select(hs_data2, mean_pm, mean_o3, pct_tree_cover, pct_impervious,
            mean_aadt_intensity, dist_m_tri:dist_m_mine_well,
            cvd_rate_adj, res_rate_adj, violent_crime_rate, property_crime_rate,
            pct_less_hs, pct_unemp, pct_limited_eng, pct_hh_pov) %>%
  as.matrix()
head(X)
```

Variance and histograms of the exposure variables (in their original units):

```{r}
var(X)
ggplot(pivot_longer(as.data.frame(X), mean_pm:pct_hh_pov, names_to = "exp", values_to = "value")) + 
    geom_histogram(aes(x = value)) + 
    facet_wrap(~ exp, scales = "free")
```

Scaling the exposure variables

```{r}
X.scaled <- apply(X, 2, scale)
head(X.scaled)
```

Variance and histograms of the exposure variables (scaled):

```{r}
var(X.scaled)
ggplot(pivot_longer(as.data.frame(X.scaled), mean_pm:pct_hh_pov, 
                    names_to = "exp", values_to = "value")) + 
    geom_histogram(aes(x = value)) + 
    facet_wrap(~ exp, scales = "free")
```

## Covariate data

Covariates were assessed at the individual level. These were selected based on previous HS studies and others in the literature and informed by a DAG.

NOTE: It'll be interesting to see what comes out of our BEAMERS discussion re: adjusting for gestational age. It's currently in the analysis

There are four continuous covariates; all of the others have been coded as dummy variables. For the dummy variables, the reference groups are: white_re, ed_grad, norm_bmi

```{r}
W <- select(hs_data2, latina_re, black_re, other_re,
            ed_no_hs, ed_hs, ed_aa, ed_4yr,
            low_bmi, ovwt_bmi, obese_bmi,
            maternal_age, any_smoker, smokeSH, mean_cpss, mean_epsd,
            male, gest_age_w) %>%
  as.matrix()
head(W)
```

Scaled the non-binary (continuous) covariates

```{r}
W.s <- apply(W[,c(11, 14, 15, 17)], 2, scale) #' just the continuous ones

W.scaled <- cbind(W[,1:10], W.s[,1],
                  W[,12:13], W.s[,2:3],
                  W[,16], W.s[,4])
colnames(W.scaled)
colnames(W.scaled) <- colnames(W)
head(W.scaled)
summary(W.scaled)
```

Variance and histograms for the scaled covariates

```{r}
var(W.scaled)

ggplot(pivot_longer(as.data.frame(W.scaled), latina_re:gest_age_w, 
                    names_to = "exp", values_to = "value")) + 
    geom_histogram(aes(x = value)) + 
    facet_wrap(~ exp, scales = "free")
```

## Response data: birth weight

```{r}
Y <- select(hs_data2, birth_weight) %>%
  as.matrix()
head(Y)
```

Distribution of birth weight and scaled birth weight

```{r}
hist(Y, breaks = 20)
hist(scale(Y), breaks = 20)
```

## Scatterplots of exposures and outcome (birth weight)

Both birth weight (Y) and the exposures are scaled here

**NOTE**: Don't use these plots as a way to estimate how many predictors might make the cut. This should be done a priori

```{r}
df <- as.data.frame(cbind(scale(Y), X.scaled))
# par(mfrow=c(5,4))
sapply(2:length(df), function(x){
  lm.x <- lm(birth_weight ~ df[,x], data = df)
  plot(df[,c(x, 1)],
       xlab = paste0(colnames(df)[x], " beta: ",
                     round(summary(lm.x)$coef[2,1],4),
                     "; p = ",
                     round(summary(lm.x)$coef[2,4],4)))
  abline(lm.x)
})
```

# Is gestational age a potenital mediator?

I.e., is there a relationship between our exposures and gestational age?

The DAG might look something like this:

exposures ---> gestational age ---> birth weight

## Scatter plots for exposures and gestational age

Both gestational age and the exposures are scaled here.
Gestational age measured in weeks from estimated date of conception to delivery

Since there were some (small) relationships between exposures and gestational age (based on simple linear regression models-- namely the ozone and SES indicators), I'm going to omit this covariate for now. 

```{r}
df2 <- as.data.frame(cbind(W.scaled[,"gest_age_w"], X.scaled))
colnames(df2)[1] <- "gest_age_w"
# par(mfrow=c(5,4))
sapply(2:length(df2), function(x){
  lm.x <- lm(gest_age_w ~ df2[,x], data = df2)
  plot(df2[,c(x, 1)],
       xlab = paste0(colnames(df2)[x], " beta: ",
                     round(summary(lm.x)$coef[2,1],4),
                     "; p = ",
                     round(summary(lm.x)$coef[2,4],4)))
  abline(lm.x)
})
```

Dropping gest_age_w from the covariates

```{r}
W.scaled2 <- W.scaled[,-c(ncol(W.scaled))]
colnames(W.scaled2)
```

# RIDGE regression

To see if there might be something going on, Lauren suggested a ridge regression with a small penalty.

```{r}
set.seed(123)

library(glmnet)

lambda_seq <- 10^seq(2, -2, by = -.1)

#' Best lambda from CV
ridge_cv <- cv.glmnet(X.scaled, scale(Y), alpha = 0, lambda = lambda_seq)
plot(ridge_cv)
best_lambda <- ridge_cv$lambda.min
best_lambda

#' Fit the model using the best_lambda
bw_ridge <- glmnet(X.scaled, scale(Y), alpha = 0, lambda = best_lambda)
summary(bw_ridge)
```

Ridge regression coefficients

```{r}
coef(bw_ridge)
```

Ridge regression predictions

```{r}
ridge_pred <- predict(bw_ridge, newx = X.scaled)
plot(scale(Y), ridge_pred)

actual <- scale(Y)
preds <- ridge_pred
rsq <- 1 - (sum((preds - actual) ^ 2))/(sum((actual - mean(actual)) ^ 2))
```

The R2 value for this model is `r round(rsq, 2)`. Based on these results, it doesn't look like there's much here.

# Nonparametric Bayesian Shrinkage (NPB): Birth weight

Still, we wanted to try to fit the NPB model with these data.

## Finding the NPB priors

Start with Lauren's from the example in the vignette

In an email from April 29, Lauren provided me with some additional guidance
on finding the NPB priors:

- Keep alpha.pi and beta.pi set to 1, and then let a.phi1 take values 1, 10, and 100 and see how the results change.
- Keep a.phi1 set to 1 (or 10 or 100), and mess with alpha.pi and beta.pi.
    - Run the following code:
       alpha.pi=1
       beta.pi=1
       plot(density(rbeta(10000, alpha.pi, beta.pi)))
       and then change alpha.pi and beta.pi and see how it changes the prior distribution.
    - This is the distribution of the probability of a main effect regression coefficient being 0 (aka exclusion probability). We don't want this to be too informative (you don't want high mass around just a few values). Also alpha.pi and beta.pi don't have to be the same value. You might try alpha.pi = 1 and beta.pi = 2 to get a slightly lower prior probability of exclusion. Try not to change all three (alpha.pi, beta.pi, and a.phi1) at once.
- When playing with the priors, set "interact=FALSE" and just fit the modelwith the main effects. Most of the interactions were null anyway so it shouldn't change the results too much and it will make the code run a lot faster. Then when you find a set of priors you like, you can add in "interact=TRUE" and "XWinteract=TRUE."

Some additional feedback from Lauren during our 6/10 meeting:

- The confidence intervals were really wide and heavily skewed. I'm going to try adjusting the sig2inv.mu1 parameter after the a.phi1 parameter to see if this helps
- the rbeta distributions is interpreted as the exclusion probability, so I should try to aim to have most of the mass of that distribution in the middle, since we hypothesize that maybe 40-60% of the predictors will be important. The way to do this is to set alpha.pi and beta.pi to the same value
- I should set the burn in number to be about half the iterations

### Vignette Priors

```{r}
set.seed(123)

priors.npb.1 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 1)

fit.npb.1 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.1, interact = F)
npb.sum.1 <- summary(fit.npb.1)
npb.sum.1$main.effects
plot(fit.npb.1$beta[,1], type = "l")
plot(fit.npb.1$beta[,2], type = "l")
plot(fit.npb.1$beta[,13], type = "l")
```

### Adjust sig2inv.mu1

The default value for this parameter is 1.
Adjusting this parameter may help narrow these confidence intervals a bit

#### Try sig2inv.mu1 = 10

That seemed to make the confidence intervals wider

```{r}
priors.npb.2 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     sig2inv.mu1 = 10)

fit.npb.2 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.2, interact = F)
npb.sum.2 <- summary(fit.npb.2)
npb.sum.2$main.effects
plot(fit.npb.2$beta[,1], type = "l")
plot(fit.npb.2$beta[,2], type = "l")
plot(fit.npb.2$beta[,13], type = "l")
```

#### Try sig2inv.mu1 = 100

That also seemed to make the confidence intervals wider

```{r}
priors.npb.3 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     sig2inv.mu1 = 100)

fit.npb.3 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.3, interact = F)
npb.sum.3 <- summary(fit.npb.3)
npb.sum.3$main.effects
plot(fit.npb.3$beta[,1], type = "l")
plot(fit.npb.3$beta[,2], type = "l")
plot(fit.npb.3$beta[,13], type = "l")
```

#### Try sig2inv.mu1 = 0.1?

This might be too narrow?

```{r}
priors.npb.4 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     sig2inv.mu1 = 0.1)

fit.npb.4 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.4, interact = F)
npb.sum.4 <- summary(fit.npb.4)
npb.sum.4$main.effects
plot(fit.npb.4$beta[,1], type = "l")
plot(fit.npb.4$beta[,2], type = "l")
plot(fit.npb.4$beta[,13], type = "l")
```

#### Try sig2inv.mu1 = 0.5?

Also too narrow-- going back to 1

```{r}
priors.npb.4 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     sig2inv.mu1 = 0.1)

fit.npb.4 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.4, interact = F)
npb.sum.4 <- summary(fit.npb.4)
npb.sum.4$main.effects
plot(fit.npb.4$beta[,1], type = "l")
plot(fit.npb.4$beta[,2], type = "l")
plot(fit.npb.4$beta[,13], type = "l")
```

### Next, try adjusting a.phi1

This parameter is the shape parameter for gamma prior on phi sub1 inv2.
It's default value is 1

#### Try making a.phi1 = 10
PIPs again increase slightly

```{r}
priors.npb.5 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10)

fit.npb.5 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.5, interact = F)
npb.sum.5 <- summary(fit.npb.5)
npb.sum.5$main.effects
plot(fit.npb.5$beta[,1], type = "l")
plot(fit.npb.5$beta[,2], type = "l")
plot(fit.npb.5$beta[,13], type = "l")
```

#### Try making a.phi1 = 10 and sig2inv.mu1 = 10

Definitely worse in terms of the confidence intervals

```{r}
priors.npb.6 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10, sig2inv.mu1 = 10)

fit.npb.6 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.6, interact = F)
npb.sum.6 <- summary(fit.npb.6)
npb.sum.6$main.effects
plot(fit.npb.6$beta[,1], type = "l")
plot(fit.npb.6$beta[,2], type = "l")
plot(fit.npb.6$beta[,13], type = "l")
```

#### Try making a.phi1 = 10 and sig2inv.mu1 = 100

Not an improvement

```{r}
priors.npb.7 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10, sig2inv.mu1 = 100)

fit.npb.7 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.7, interact = F)
npb.sum.7 <- summary(fit.npb.7)
npb.sum.7$main.effects
plot(fit.npb.7$beta[,1], type = "l")
plot(fit.npb.7$beta[,2], type = "l")
plot(fit.npb.7$beta[,13], type = "l")
```

#### Try making a.phi1 = 10 and sig2inv.mu1 = 0.1

Nope

```{r}
priors.npb.8 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10, sig2inv.mu1 = 0.1)

fit.npb.8 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.8, interact = F)
npb.sum.8 <- summary(fit.npb.8)
npb.sum.8$main.effects
plot(fit.npb.8$beta[,1], type = "l")
plot(fit.npb.8$beta[,2], type = "l")
plot(fit.npb.8$beta[,13], type = "l")
```

#### Try making a.phi1 = 100

```{r}
priors.npb.9 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 100, sig2inv.mu1 = 1)

fit.npb.9 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.9, interact = F)
npb.sum.9 <- summary(fit.npb.9)
npb.sum.9$main.effects
plot(fit.npb.9$beta[,1], type = "l")
plot(fit.npb.9$beta[,2], type = "l")
plot(fit.npb.9$beta[,13], type = "l")
```

#### Try making a.phi1 = 100 and sig2inv.mu1 = 10

```{r}
priors.npb.10 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 100, sig2inv.mu1 = 10)

fit.npb.10 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.10, interact = F)
npb.sum.10 <- summary(fit.npb.10)
npb.sum.10$main.effects
plot(fit.npb.10$beta[,1], type = "l")
plot(fit.npb.10$beta[,2], type = "l")
plot(fit.npb.10$beta[,13], type = "l")
```

#### Try making a.phi1 = 100 and sig2inv.mu1 = 100

Still not great.

```{r}
priors.npb.11 <- list(alpha.pi = 1, beta.pi = 1, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 100, sig2inv.mu1 = 100)

fit.npb.11 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.11, interact = F)
npb.sum.11 <- summary(fit.npb.11)
npb.sum.11$main.effects
plot(fit.npb.11$beta[,1], type = "l")
plot(fit.npb.11$beta[,2], type = "l")
plot(fit.npb.11$beta[,13], type = "l")
```

### Adjust alpha.pi and beta.pi

For now, leave a.phi1 and sig2inv.mu1 alone for now.

alpha.pi and beta.pi are responisble for the exclusion probability distribution.
If we thing we want ~50% of our covariates, we need the mass of this distribution to be somewhere between 0.4 and 0.6. To do this, we set alpha.pi and beta.pi to the same value

#### Try making alpha.pi and beta.pi 2

```{r}
plot(density(rbeta(10000, 2, 2)))

priors.npb.12 <- list(alpha.pi = 2, beta.pi = 2, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 1, sig2inv.mu1 = 1)

fit.npb.12 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.12, interact = F)
npb.sum.12 <- summary(fit.npb.12)
npb.sum.12$main.effects
plot(fit.npb.12$beta[,1], type = "l")
plot(fit.npb.12$beta[,2], type = "l")
plot(fit.npb.12$beta[,13], type = "l")
```

#### Try making alpha.pi and beta.pi 5

```{r}
plot(density(rbeta(10000, 5, 5)))

priors.npb.13 <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 1, sig2inv.mu1 = 1)

fit.npb.13 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.13, interact = F)
npb.sum.13 <- summary(fit.npb.13)
npb.sum.13$main.effects
plot(fit.npb.13$beta[,1], type = "l")
plot(fit.npb.13$beta[,2], type = "l")
plot(fit.npb.13$beta[,13], type = "l")
```

#### Try making alpha.pi and beta.pi 8

```{r}
plot(density(rbeta(10000, 8, 8)))

priors.npb.14 <- list(alpha.pi = 8, beta.pi = 8, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 1, sig2inv.mu1 = 1)

fit.npb.14 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.14, interact = F)
npb.sum.14 <- summary(fit.npb.14)
npb.sum.14$main.effects
plot(fit.npb.14$beta[,1], type = "l")
plot(fit.npb.14$beta[,2], type = "l")
plot(fit.npb.14$beta[,13], type = "l")
```

#### Try making alpha.pi and beta.pi 10

This might be getting too big... Is there enough space in the tails?

```{r}
plot(density(rbeta(10000, 10, 10)))

priors.npb.15 <- list(alpha.pi = 10, beta.pi = 10, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 1, sig2inv.mu1 = 1)

fit.npb.15 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.15, interact = F)
npb.sum.15 <- summary(fit.npb.15)
npb.sum.15$main.effects
plot(fit.npb.15$beta[,1], type = "l")
plot(fit.npb.15$beta[,2], type = "l")
plot(fit.npb.15$beta[,13], type = "l")
```

### Set alpha.pi and beta.pi to 8, readjust a.phi1 and sig2inv.mu1

Set  alpha.pi and beta.pi to 8, try adjusting a.phi1 and sig2inv.mu1

#### Try making a.phi1 = 10 and sig2inv.mu1 = 1

```{r}
priors.npb.16 <- list(alpha.pi = 8, beta.pi = 8, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10, sig2inv.mu1 = 1)

fit.npb.16 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.16, interact = F)
npb.sum.16 <- summary(fit.npb.16)
npb.sum.16$main.effects
plot(fit.npb.16$beta[,1], type = "l")
plot(fit.npb.16$beta[,2], type = "l")
plot(fit.npb.16$beta[,13], type = "l")
```

Same priors, but now with ```scaleY = F```

```{r}
priors.npb.16a <- list(alpha.pi = 8, beta.pi = 8, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10, sig2inv.mu1 = 1)

fit.npb.16a <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = FALSE,
                 priors = priors.npb.16a, interact = F)
npb.sum.16a <- summary(fit.npb.16a)
npb.sum.16a$main.effects
plot(fit.npb.16a$beta[,1], type = "l")
plot(fit.npb.16a$beta[,2], type = "l")
plot(fit.npb.16a$beta[,13], type = "l")
```

#### Try making a.phi1 = 10 and sig2inv.mu1 = 10

```{r}
priors.npb.17 <- list(alpha.pi = 8, beta.pi = 8, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10, sig2inv.mu1 = 10)

fit.npb.17 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.17, interact = F)
npb.sum.17 <- summary(fit.npb.17)
npb.sum.17$main.effects
plot(fit.npb.17$beta[,1], type = "l")
plot(fit.npb.17$beta[,2], type = "l")
plot(fit.npb.17$beta[,13], type = "l")
```

#### Try making a.phi1 = 10 and sig2inv.mu1 = 100

```{r}
priors.npb.18 <- list(alpha.pi = 8, beta.pi = 8, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10, sig2inv.mu1 = 100)

fit.npb.18 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.18, interact = F)
npb.sum.18 <- summary(fit.npb.18)
npb.sum.18$main.effects
plot(fit.npb.18$beta[,1], type = "l")
plot(fit.npb.18$beta[,2], type = "l")
plot(fit.npb.18$beta[,13], type = "l")
```

#### Try making a.phi1 = 100 and sig2inv.mu1 = 1

```{r}
priors.npb.19 <- list(alpha.pi = 8, beta.pi = 8, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 100, sig2inv.mu1 = 1)

fit.npb.19 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.19, interact = F)
npb.sum.19 <- summary(fit.npb.19)
npb.sum.19$main.effects
plot(fit.npb.19$beta[,1], type = "l")
plot(fit.npb.19$beta[,2], type = "l")
plot(fit.npb.19$beta[,13], type = "l")
```

#### Try making a.phi1 = 100 and sig2inv.mu1 = 10

```{r}
priors.npb.20 <- list(alpha.pi = 8, beta.pi = 8, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 100, sig2inv.mu1 = 10)

fit.npb.20 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.20, interact = F)
npb.sum.20 <- summary(fit.npb.20)
npb.sum.20$main.effects
plot(fit.npb.20$beta[,1], type = "l")
plot(fit.npb.20$beta[,2], type = "l")
plot(fit.npb.20$beta[,13], type = "l")
```

#### Try making a.phi1 = 100 and sig2inv.mu1 = 100

```{r}
priors.npb.21 <- list(alpha.pi = 8, beta.pi = 8, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 100, sig2inv.mu1 = 100)

fit.npb.21 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.21, interact = F)
npb.sum.21 <- summary(fit.npb.21)
npb.sum.21$main.effects
plot(fit.npb.21$beta[,1], type = "l")
plot(fit.npb.21$beta[,2], type = "l")
plot(fit.npb.21$beta[,13], type = "l")
```

Same priors, but with scaleY = F

```{r}
priors.npb.21a <- list(alpha.pi = 8, beta.pi = 8, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 100, sig2inv.mu1 = 100)

fit.npb.21a <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = F,
                 priors = priors.npb.21a, interact = F)
npb.sum.21a <- summary(fit.npb.21a)
npb.sum.21a$main.effects
plot(fit.npb.21a$beta[,1], type = "l")
plot(fit.npb.21a$beta[,2], type = "l")
plot(fit.npb.21a$beta[,13], type = "l")
```

#### Try making a.phi1 = 10e5 and sig2inv.mu1 = 10e5

```{r}
priors.npb.22 <- list(alpha.pi = 8, beta.pi = 8, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10e5, sig2inv.mu1 = 10e5)

fit.npb.22 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.22, interact = F)
npb.sum.22 <- summary(fit.npb.22)
npb.sum.22$main.effects
plot(fit.npb.22$beta[,1], type = "l")
plot(fit.npb.22$beta[,2], type = "l")
plot(fit.npb.22$beta[,13], type = "l")
```

Same priors, but with scaleY = F

```{r}
priors.npb.22a <- list(alpha.pi = 8, beta.pi = 8, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10e5, sig2inv.mu1 = 10e5)

fit.npb.22a <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = FALSE,
                 priors = priors.npb.22a, interact = F)
npb.sum.22a <- summary(fit.npb.22a)
npb.sum.22a$main.effects
plot(fit.npb.22a$beta[,1], type = "l")
plot(fit.npb.22a$beta[,2], type = "l")
plot(fit.npb.22a$beta[,13], type = "l")
```

### Set alpha.pi and beta.pi to 5, readjust a.phi1 and sig2inv.mu1

Set alpha.pi and beta.pi to 5, rather than 8, and try adjusting a.phi1 and sig2inv.mu1

#### Try making a.phi1 = 10 and sig2inv.mu1 = 1

```{r}
priors.npb.23 <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10, sig2inv.mu1 = 1)

fit.npb.23 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.23, interact = F)
npb.sum.23 <- summary(fit.npb.23)
npb.sum.23$main.effects
plot(fit.npb.23$beta[,1], type = "l")
plot(fit.npb.23$beta[,2], type = "l")
plot(fit.npb.23$beta[,13], type = "l")
```

Same priors, but now with ```scaleY = F```

```{r}
priors.npb.23a <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10, sig2inv.mu1 = 1)

fit.npb.23a <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = FALSE,
                 priors = priors.npb.23a, interact = F)
npb.sum.23a <- summary(fit.npb.23a)
npb.sum.23a$main.effects
plot(fit.npb.23a$beta[,1], type = "l")
plot(fit.npb.23a$beta[,2], type = "l")
plot(fit.npb.23a$beta[,13], type = "l")
```

#### Try making a.phi1 = 10 and sig2inv.mu1 = 10

```{r}
priors.npb.24 <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10, sig2inv.mu1 = 10)

fit.npb.24 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.24, interact = F)
npb.sum.24 <- summary(fit.npb.24)
npb.sum.24$main.effects
plot(fit.npb.24$beta[,1], type = "l")
plot(fit.npb.24$beta[,2], type = "l")
plot(fit.npb.24$beta[,13], type = "l")
```

#### Try making a.phi1 = 10 and sig2inv.mu1 = 100

```{r}
priors.npb.25 <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10, sig2inv.mu1 = 100)

fit.npb.25 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.25, interact = F)
npb.sum.25 <- summary(fit.npb.25)
npb.sum.25$main.effects
plot(fit.npb.25$beta[,1], type = "l")
plot(fit.npb.25$beta[,2], type = "l")
plot(fit.npb.25$beta[,13], type = "l")
```

#### Try making a.phi1 = 100 and sig2inv.mu1 = 1

```{r}
priors.npb.26 <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 100, sig2inv.mu1 = 1)

fit.npb.26 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.26, interact = F)
npb.sum.26 <- summary(fit.npb.26)
npb.sum.26$main.effects
plot(fit.npb.26$beta[,1], type = "l")
plot(fit.npb.26$beta[,2], type = "l")
plot(fit.npb.26$beta[,13], type = "l")
```

#### Try making a.phi1 = 100 and sig2inv.mu1 = 10

```{r}
priors.npb.27 <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 100, sig2inv.mu1 = 10)

fit.npb.27 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.27, interact = F)
npb.sum.27 <- summary(fit.npb.27)
npb.sum.27$main.effects
plot(fit.npb.27$beta[,1], type = "l")
plot(fit.npb.27$beta[,2], type = "l")
plot(fit.npb.27$beta[,13], type = "l")
```

#### Try making a.phi1 = 100 and sig2inv.mu1 = 100

```{r}
priors.npb.28 <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 100, sig2inv.mu1 = 100)

fit.npb.28 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.28, interact = F)
npb.sum.28 <- summary(fit.npb.28)
npb.sum.28$main.effects
plot(fit.npb.28$beta[,1], type = "l")
plot(fit.npb.28$beta[,2], type = "l")
plot(fit.npb.28$beta[,13], type = "l")
```

Same priors, but with scaleY = F

```{r}
priors.npb.28a <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 100, sig2inv.mu1 = 100)

fit.npb.28a <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = F,
                 priors = priors.npb.28a, interact = F)
npb.sum.28a <- summary(fit.npb.28a)
npb.sum.28a$main.effects
plot(fit.npb.28a$beta[,1], type = "l")
plot(fit.npb.28a$beta[,2], type = "l")
plot(fit.npb.28a$beta[,13], type = "l")
```

#### Try making a.phi1 = 10e5 and sig2inv.mu1 = 10e5

```{r}
priors.npb.29 <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10e5, sig2inv.mu1 = 10e5)

fit.npb.29 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.29, interact = F)
npb.sum.29 <- summary(fit.npb.29)
npb.sum.29$main.effects
plot(fit.npb.29$beta[,1], type = "l")
plot(fit.npb.29$beta[,2], type = "l")
plot(fit.npb.29$beta[,13], type = "l")
```

Same priors, but with scaleY = F

```{r}
priors.npb.29a <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 10e5, sig2inv.mu1 = 10e5)

fit.npb.29a <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = FALSE,
                 priors = priors.npb.29a, interact = F)
npb.sum.29a <- summary(fit.npb.29a)
npb.sum.29a$main.effects
plot(fit.npb.29a$beta[,1], type = "l")
plot(fit.npb.29a$beta[,2], type = "l")
plot(fit.npb.29a$beta[,13], type = "l")
```

### Set alpha.pi and beta.pi to 5, set a.phi1 = 1, and adjust sig2inv.mu1

#### Try making a.phi1 = 1 and sig2inv.mu1 = 10

```{r}
priors.npb.30 <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 1, sig2inv.mu1 = 10)

fit.npb.30 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.30, interact = F)
npb.sum.30 <- summary(fit.npb.30)
npb.sum.30$main.effects
plot(fit.npb.30$beta[,1], type = "l")
plot(fit.npb.30$beta[,2], type = "l")
plot(fit.npb.30$beta[,13], type = "l")
```

Same priors, but with scaleY = F

```{r}
priors.npb.30a <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 1, sig2inv.mu1 = 10)

fit.npb.30a <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = FALSE,
                 priors = priors.npb.30a, interact = F)
npb.sum.30a <- summary(fit.npb.30a)
npb.sum.30a$main.effects
plot(fit.npb.30a$beta[,1], type = "l")
plot(fit.npb.30a$beta[,2], type = "l")
plot(fit.npb.30a$beta[,13], type = "l")
```

#### Try making a.phi1 = 1 and sig2inv.mu1 = 100

```{r}
priors.npb.31 <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 1, sig2inv.mu1 = 100)

fit.npb.31 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.31, interact = F)
npb.sum.31 <- summary(fit.npb.31)
npb.sum.31$main.effects
plot(fit.npb.31$beta[,1], type = "l")
plot(fit.npb.31$beta[,2], type = "l")
plot(fit.npb.31$beta[,13], type = "l")
```

Same priors, but with scaleY = F

```{r}
priors.npb.31a <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 1, sig2inv.mu1 = 100)

fit.npb.31a <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = FALSE,
                 priors = priors.npb.31a, interact = F)
npb.sum.31a <- summary(fit.npb.31a)
npb.sum.31a$main.effects
plot(fit.npb.31a$beta[,1], type = "l")
plot(fit.npb.31a$beta[,2], type = "l")
plot(fit.npb.31a$beta[,13], type = "l")
```

#### Try making a.phi1 = 1 and sig2inv.mu1 = 10e5

```{r}
priors.npb.32 <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 1, sig2inv.mu1 = 10e5)

fit.npb.32 <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = TRUE,
                 priors = priors.npb.32, interact = F)
npb.sum.32 <- summary(fit.npb.32)
npb.sum.32$main.effects
plot(fit.npb.32$beta[,1], type = "l")
plot(fit.npb.32$beta[,2], type = "l")
plot(fit.npb.32$beta[,13], type = "l")
```

Same priors, but with scaleY = F

```{r}
priors.npb.32a <- list(alpha.pi = 5, beta.pi = 5, alpha.pi2 = 9, beta.pi2 = 1,
                     a.phi1 = 1, sig2inv.mu1 = 10e5)

fit.npb.32a <- npb(niter = 1000, nburn = 500, X = X.scaled, Y = Y, W = W.scaled2,
                 scaleY = FALSE,
                 priors = priors.npb.32a, interact = F)
npb.sum.32a <- summary(fit.npb.32a)
npb.sum.32a$main.effects
plot(fit.npb.32a$beta[,1], type = "l")
plot(fit.npb.32a$beta[,2], type = "l")
plot(fit.npb.32a$beta[,13], type = "l")
```

## Fit the NPB model

Below I've used the 24th set of priors and set ```scaleY = T```

The priors are as follows:
```r priors.npb.24```

Note that this version of the model does not include gest_age_w.

```{r}
priors.npb <- priors.npb.24

fit.npb <- npb(niter = 10000, nburn = 2500, X = X.scaled, Y = Y, W = W.scaled2,
               scaleY = TRUE,
               priors = priors.npb, interact = TRUE, XWinteract = TRUE)
save(fit.npb, file = here::here("Results", "NPB_Birth_Weight.rdata"))

# load(here::here("Results", "NPB_Birth_Weight.rdata"))
npb.sum <- summary(fit.npb)
```

### First, main effect regression coefficients with PIPs

```{r}
npb.sum$main.effects
selected_exp <- which(npb.sum$main.effects[,5] >= 0.5)
selected_exp

#' Which variables are these?
exp_names <- colnames(X)[selected_exp]
exp_names
```

### Interactions
Next, all of the interactions between exposures or between exposures and covariates

```{r}
npb.sum$interactions
```

### Predict fitted values for each individual

```{r}
pred.npb <- predict(fit.npb)
fittedvals <- pred.npb$fitted.vals
```

### Plot predicted outcomes against "measured" outcomes

```{r}
plot(fittedvals, Y)
abline(a = 0, b = 1, col = "red")
```
